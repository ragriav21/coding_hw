---
title: "Conservancy Analysis"
author: "BEACN"
date: "March 23, 2018"
output:
  pdf_document: default
  html_document: default
---

## Setup

Downloading the data

```{r results = 'hide'}

library(tidyverse)
library(ggplot2)
library(stringr)
library(gridExtra)
library(grid)

conservancy_names <- function(name) {
  return(paste0("conservancy_", name, ".csv")) 
}

ucnrs_names <- function(name) {
  return(paste0("ucnrs_", name, ".csv"))
}

conservancyNames <- c("birds", "herpetofauna", "invertebrates", "mammals", "plants")

ucnrsNames <- c("animal_list", "plant_list")

fullConservancyNames <- conservancy_names(conservancyNames)
fullUCNRSNames <- ucnrs_names(ucnrsNames)

allFiles <- c(fullConservancyNames, fullUCNRSNames)
path <- paste0("./ucnrs_data/", allFiles)

data <- lapply(path, read_csv) 
head(data)

```

## Combining UCNRS and Conservancy into four datasets


```{r}

# Separating out columns of data for conservancy data and removing irrelevant values

conservancyAnimalData <- bind_rows(data[[1]], data[[2]], data[[3]], data[[4]]) %>% 
  distinct(species) %>% 
  separate(species, into = c("genus", "species", "sublabel1", "sublabel2"), sep = " ", extra = "merge") %>% 
  filter(!(genus %in% c("Tejon", "Undefined")))

conservancyPlantData <- data[[5]] %>% distinct(species) %>% 
  separate(species, into = c("genus", "species", "separator_label", "sublabel"), sep = " ", extra = "merge") %>% 
  filter(!(genus %in% c("Tejon", "Undefined")))

# Loading Plant and Animal data from UCNRS

ucnrsPlantData <- data[[7]]
ucnrsAnimalData <- data[[6]]

# Relabeling data

names(ucnrsPlantData)[7:8] <- c("separator_label", "sublabel")
names(ucnrsAnimalData)[4] <- "scientific_name"

# Cleaning UCNRS Animal data

ucnrsAnimalDataSubsetTemp <- ucnrsAnimalData %>% 
  select(Reserve, scientific_name) %>% 
  separate(scientific_name, into = c("genus", "species", "sublabel1", "sublabel2"), sep = " ", extra = "merge") %>%
  distinct()


ucnrsAnimalDataSubset <-  mutate(ucnrsAnimalDataSubsetTemp, 
                                 sublabel1 = gsub("\\(", "", sublabel1), sublabel2 = gsub("\\(", "", sublabel2), 
         sublabel1 = gsub("\\)", "", sublabel1), sublabel2 = gsub("\\)", "", sublabel2),
         sublabel1 = gsub("\\.", "", sublabel1), sublabel2 = gsub("\\.", "", sublabel2), 
         species = tolower(species))

# Cleaning UCNRS Plant Data

ucnrsPlantDataSubset <- ucnrsPlantData %>% 
  select(Reserve, Genus, Species, separator_label, sublabel) %>%
  distinct()

# Relabeling column headers

names(ucnrsPlantDataSubset)[1:3] <- c("reserve", "genus", "species")
names(ucnrsAnimalDataSubset)[1] <- c("reserve")

# Print results

head(ucnrsAnimalDataSubset)
head(ucnrsPlantDataSubset)
head(conservancyAnimalData)
head(conservancyPlantData)

```

## Match Ratio of Plants per Reserve

```{r}
# Find shared genies and species of plants
matchingPlants <- semi_join(ucnrsPlantDataSubset, conservancyPlantData, by = c("genus", "species", "sublabel")) %>%
  select(reserve, genus, species, sublabel)

# Calculate how similar plant species composition is by reserve
matchingPlantsCount <- matchingPlants %>% 
  group_by(reserve) %>% 
  summarize(count = n())

totalPlantsCount <- ucnrsPlantDataSubset %>% 
  group_by(reserve) %>% 
  summarize(count = n())

plantsComparisonTable <- left_join(matchingPlantsCount, totalPlantsCount, 
                                   by = "reserve", suffix = c("_matching", "_total")) %>% 
  mutate(match_ratio = count_matching / count_total) %>% 
  arrange(desc(match_ratio))

plantsComparisonTable

```


## Where each plant is found

```{r}
# Find places where each matched species shows up in other reserves

matchingPlantsArranged <- matchingPlants %>% 
  arrange(genus, species, sublabel, reserve) 

matchingPlantsReserves <- matchingPlantsArranged  %>% 
  group_by(genus, species, sublabel) %>% 
  summarize(count = n()) 

# Add names of reserves each species is represented in at end:

matchingPlantsArranged$reserve_list <- ""

matchingPlantsArranged$reserve_list[1] <- paste0(matchingPlantsArranged$reserve[1])
idx = 2
idx_max = nrow(matchingPlantsArranged)

while(idx < idx_max) {
  n = 1
  while((setequal(matchingPlantsArranged[idx, 2:4], matchingPlantsArranged[(idx - 1), 2:4])) & (idx < idx_max)) {
    n = n + 1
    idx = idx + 1
  }
  matchingPlantsArranged$reserve_list[(idx - n):(idx - 1)] <- 
    paste(matchingPlantsArranged$reserve[(idx - n):(idx - 1)], collapse = ", ")
  idx = idx + 1
}

matchingPlantsArranged$reserve_list[idx_max] <- 
    paste(matchingPlantsArranged$reserve[idx_max])

# Combine the data

matchingPlantsReservesCombined <- matchingPlantsArranged %>% 
  distinct(genus, species, sublabel, reserve_list) %>% 
  right_join(matchingPlantsReserves, by = c("genus", "species", "sublabel"))

matchingPlantsReservesCombined
```

## Match Ratio of Animals
per Reserve

```{r}
# Find shared genies and species of plants
matchingAnimals <- semi_join(ucnrsAnimalDataSubset, conservancyAnimalData, by = c("genus", "species", "sublabel1")) %>%
  select(reserve, genus, species, sublabel1, sublabel2)

# Calculate how similar plant species composition is by reserve
matchingAnimalsCount <- matchingAnimals %>% 
  group_by(reserve) %>% 
  summarize(count = n())

totalAnimalsCount <- ucnrsAnimalDataSubset %>% 
  group_by(reserve) %>% 
  summarize(count = n())

animalsComparisonTable <- left_join(matchingAnimalsCount, totalAnimalsCount, 
                                   by = "reserve", suffix = c("_matching", "_total")) %>% 
  mutate(match_ratio = count_matching / count_total) %>% 
  arrange(desc(match_ratio))

animalsComparisonTable

```


## Where each plant is found

```{r}

# Find places where each matched species shows up in other reserves

matchingAnimalsArranged <- matchingAnimals %>% 
  arrange(genus, species, sublabel1, reserve) 

matchingAnimalsReserves <- matchingAnimalsArranged  %>% 
  group_by(genus, species, sublabel1) %>% 
  summarize(count = n()) 

# Add names of reserves each species is represented in at end:

matchingAnimalsArranged$reserve_list <- ""

matchingAnimalsArranged$reserve_list[1] <- paste0(matchingAnimalsArranged$reserve[1])
idx = 2
idx_max = nrow(matchingAnimalsArranged)

while(idx < idx_max) {
  n = 1
  while((setequal(matchingAnimalsArranged[idx, 2:4], matchingAnimalsArranged[(idx - 1), 2:4])) & (idx < idx_max)) {
    n = n + 1
    idx = idx + 1
  }
  matchingAnimalsArranged$reserve_list[(idx - n):(idx - 1)] <- 
    paste(matchingAnimalsArranged$reserve[(idx - n):(idx - 1)], collapse = ", ")
  idx = idx + 1
}

matchingAnimalsArranged$reserve_list[idx_max] <- 
    paste(matchingAnimalsArranged$reserve[idx_max])

# Combine the data

matchingAnimalsReservesCombined <- matchingAnimalsArranged %>% 
  distinct(genus, species, sublabel1, reserve_list) %>% 
  right_join(matchingAnimalsReserves, by = c("genus", "species", "sublabel1"))

matchingAnimalsReservesCombined
```

## Visuals & Summary Statistics

```{r}

plantsComparisonTable %>% 
  filter(match_ratio > 0.25) %>% 
  ggplot(aes(x = reorder(reserve, match_ratio), y = match_ratio)) + 
  geom_bar(stat = "identity") +
  coord_flip()

animalsComparisonTable %>% 
  filter(match_ratio > 0.25) %>% 
  ggplot(aes(x = reorder(reserve, match_ratio), y = match_ratio)) + 
  geom_bar(stat = "identity") +
  coord_flip()

```

## Unique Plants and Animals


```{r}

uniquePlants <- conservancyPlantData %>% anti_join(ucnrsPlantDataSubset, by = c("genus", "species", "sublabel"))
uniqueAnimals <- conservancyAnimalData %>% anti_join(ucnrsAnimalDataSubset, by = c("genus", "species", "sublabel1"))


totalPlantsNum <- nrow(conservancyPlantData)
uniquePlantsNum <- nrow(uniquePlants)

totalAnimalsNum <- nrow(conservancyAnimalData)
uniqueAnimalsNum <- nrow(uniqueAnimals)

ratioUniquePlants <- uniquePlantsNum / totalPlantsNum
ratioUniqueAnimals <- uniqueAnimalsNum / totalAnimalsNum

rarePlants <- matchingPlantsReservesCombined %>% filter(count < 4)
rarePlantsNum <- nrow(rarePlants)
rareOrUniquePlantsNum <- uniquePlantsNum + rarePlantsNum

rareAnimals <- matchingAnimalsReservesCombined %>% filter(count < 4)
rareAnimalsNum <- nrow(rareAnimals)
rareOrUniqueAnimalsNum <- uniqueAnimalsNum + rareAnimalsNum

ratioRareOrUniquePlants <- rareOrUniquePlantsNum / totalPlantsNum
ratioRareOrUniqueAnimals <- rareOrUniqueAnimalsNum / totalAnimalsNum


ratioUniquePlants
ratioRareOrUniquePlants

ratioUniqueAnimals
ratioRareOrUniqueAnimals

uniquePlants
uniqueAnimals

rarePlants
rareAnimals
```

