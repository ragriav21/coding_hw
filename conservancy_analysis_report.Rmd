---
title: "Conservancy Analysis"
author: "BEACN"
date: "March 23, 2018"
output:
  pdf_document: default
  html_document: default
---

## Setup

Downloading the data

```{r Downloading Necessary Data}
library(Hmisc)
library(ggplot2)
library(stringr)
library(gridExtra)
library(tidyverse)
library(knitr)
library(kableExtra)
library(plotly)
library(RcppRoll)

conservancy_names <- function(name) {
  return(paste0("conservancy_", name, ".csv")) 
}

ucnrs_names <- function(name) {
  return(paste0("ucnrs_", name, ".csv"))
}

conservancyNames <- c("birds", "herpetofauna", "invertebrates", "mammals", "plants")

ucnrsNames <- c("animal_list", "plant_list")

fullConservancyNames <- conservancy_names(conservancyNames)
fullUCNRSNames <- ucnrs_names(ucnrsNames)

allFiles <- c(fullConservancyNames, fullUCNRSNames)
path <- paste0("./ucnrs_data/", allFiles)

data <- lapply(path, read_csv) 
head(data)

```

## Combining UCNRS and Conservancy into four datasets


```{r Combining Datasets}

# Separating out columns of data for conservancy data and removing irrelevant values

conservancyAnimalData <- bind_rows(data[[1]], data[[2]], data[[3]], data[[4]]) %>% 
  distinct(species) %>% 
  separate(species, into = c("genus", "species", "sublabel1", "sublabel2"), sep = " ", extra = "merge") %>% 
  filter(!(genus %in% c("Tejon", "Undefined")))

conservancyPlantData <- data[[5]] %>% distinct(species) %>% 
  separate(species, into = c("genus", "species", "separator_label", "sublabel"), sep = " ", extra = "merge") %>% 
  filter(!(genus %in% c("Tejon", "Undefined")))

# Loading Plant and Animal data from UCNRS

ucnrsPlantData <- data[[7]]
ucnrsAnimalData <- data[[6]]

# Relabeling data

names(ucnrsPlantData)[7:8] <- c("separator_label", "sublabel")
names(ucnrsAnimalData)[4] <- "scientific_name"

# Cleaning UCNRS Animal data

ucnrsAnimalDataSubset <- ucnrsAnimalData %>% 
  mutate(scientific_name = gsub("\\(", "", scientific_name), 
         scientific_name = gsub("\\)", "", scientific_name),
         scientific_name = gsub("\\.", "", scientific_name), 
         scientific_name = iconv(scientific_name, "utf-8", "ascii", sub=" "),
         Reserve = iconv(Reserve, "utf-8", "ascii", sub="n")) %>% 
  select(Reserve, scientific_name) %>% 
  separate(scientific_name, into = c("genus", "species", "sublabel1", "sublabel2"), sep = " ", extra = "merge") %>%
  mutate(species = tolower(species)) %>% 
  distinct()

# Cleaning UCNRS Plant Data

ucnrsPlantDataSubset <- ucnrsPlantData %>% 
  select(Reserve, Genus, Species, separator_label, sublabel) %>%
  distinct()

# Relabeling column headers

names(ucnrsPlantDataSubset)[1:3] <- c("reserve", "genus", "species")
names(ucnrsAnimalDataSubset)[1] <- c("reserve")

# Print results

head(ucnrsAnimalDataSubset)
head(ucnrsPlantDataSubset)
head(conservancyAnimalData)
head(conservancyPlantData)

```

## Match Ratio of Species per Reserve

```{r Create Plant Table}

# Find shared genies and species of plants
matchingPlants <- semi_join(ucnrsPlantDataSubset, conservancyPlantData, by = c("genus", "species", "sublabel")) %>%
  select(reserve, genus, species, sublabel)

# Calculate how similar plant species composition is by reserve
matchingPlantsCount <- matchingPlants %>% 
  group_by(reserve) %>% 
  filter(!is.na(reserve)) %>% 
  summarize(plant_species_in_reserve_also_in_conservancy = n())

# Find total plant species per reserve
totalPlantsCount <- ucnrsPlantDataSubset %>% 
  group_by(reserve) %>% 
  filter(!is.na(reserve)) %>% 
  summarize(total_plant_species_in_reserve = n())

# Total plant count for conservancy
total_plant_species_in_conservancy <- nrow(conservancyPlantData)

# Create tables comparing proportion of plants in conservancy also in reserve and vice versa 
plantsComparisonTable <- left_join(matchingPlantsCount, totalPlantsCount, 
                                   by = "reserve") %>% 
  mutate(proportion_plant_species_in_reserve_also_in_conservancy = 
           plant_species_in_reserve_also_in_conservancy / total_plant_species_in_reserve) %>% 
  mutate(percent_plant_species_in_reserve_also_in_conservancy = 
           paste0(format(100 * proportion_plant_species_in_reserve_also_in_conservancy, 
         digits = 2), "%")) %>% 
  mutate(proportion_plant_species_in_conservancy_also_in_reserve = 
           plant_species_in_reserve_also_in_conservancy / total_plant_species_in_conservancy) %>% 
  mutate(percent_plant_species_in_conservancy_also_in_reserve = 
           paste0(format(100 * proportion_plant_species_in_conservancy_also_in_reserve, 
         digits = 2), "%")) %>% 
  arrange(desc(proportion_plant_species_in_reserve_also_in_conservancy))

plantsComparisonTableConservancyEmphasis <- plantsComparisonTable %>% 
  arrange(desc(proportion_plant_species_in_conservancy_also_in_reserve))

# Visualize results
plantsComparisonTableViz <- kable(plantsComparisonTable, 
                                  format = "html", align = "lcccc", 
                                  col.names = gsub("_", " ", capitalize(colnames(plantsComparisonTable)))) %>% 
  kable_styling

plantsComparisonTableConservancyEmphasisViz <- kable(plantsComparisonTableConservancyEmphasis, 
                                  format = "html", align = "lcccc", 
                                  col.names = gsub("_", " ", capitalize(colnames(plantsComparisonTable)))) %>% 
  kable_styling

plantsComparisonTableViz
plantsComparisonTableConservancyEmphasisViz

```

```{r Create Animal Table}
# Find shared genies and species of animals
matchingAnimals <- semi_join(ucnrsAnimalDataSubset, conservancyAnimalData, by = c("genus", "species", "sublabel1")) %>%
  select(reserve, genus, species, sublabel = sublabel1)

# Calculate how similar animal species composition is by reserve
matchingAnimalsCount <- matchingAnimals %>% 
  group_by(reserve) %>% 
  filter(!is.na(reserve)) %>% 
  summarize(animal_species_in_reserve_also_in_conservancy = n()) 

totalAnimalsCount <- ucnrsAnimalDataSubset %>% 
  group_by(reserve) %>% 
  filter(!is.na(reserve)) %>% 
  summarize(total_animal_species_in_reserve = n())

# Total animal count for conservancy
total_animal_species_in_conservancy <- nrow(conservancyAnimalData)

# Create tables comparing proportion of plants in conservancy also in reserve and vice versa 

animalsComparisonTable <- left_join(matchingAnimalsCount, totalAnimalsCount, 
                                   by = "reserve") %>% 
  mutate(proportion_animal_species_in_reserve_also_in_conservancy = 
           animal_species_in_reserve_also_in_conservancy / total_animal_species_in_reserve) %>% 
  mutate(percent_animal_species_in_reserve_also_in_conservancy = 
           paste0(format(100 * proportion_animal_species_in_reserve_also_in_conservancy, 
         digits = 2), "%")) %>% 
  mutate(proportion_animal_species_in_conservancy_also_in_reserve = 
           animal_species_in_reserve_also_in_conservancy / total_animal_species_in_conservancy) %>% 
  mutate(percent_animal_species_in_conservancy_also_in_reserve = 
           paste0(format(100 * proportion_animal_species_in_conservancy_also_in_reserve, 
         digits = 2), "%")) %>% 
  arrange(desc(proportion_animal_species_in_reserve_also_in_conservancy))

animalsComparisonTableConservancyEmphasis <- animalsComparisonTable %>% 
  arrange(desc(percent_animal_species_in_conservancy_also_in_reserve))

# Visualize results
animalsComparisonTableViz <- kable(animalsComparisonTable, 
                                  format = "html", align = "lcccc", 
                                  col.names = gsub("_", " ", capitalize(colnames(animalsComparisonTable)))) %>% 
  kable_styling

animalsComparisonTableConservancyEmphasisViz <- kable(animalsComparisonTableConservancyEmphasis, 
                                  format = "html", align = "lcccc", 
                                  col.names = gsub("_", " ", capitalize(colnames(animalsComparisonTableConservancyEmphasis)))) %>% 
  kable_styling

animalsComparisonTableViz
animalsComparisonTableConservancyEmphasisViz

```

```{r Create Total Species Count}

# Combine species data
matchingSpecies <- bind_rows(matchingAnimals, matchingPlants) 

animalSpeciesDataStandardized <- ucnrsAnimalDataSubset %>% 
  select(reserve, genus, species, sublabel = sublabel1)
plantSpeciesDataStandardized <- ucnrsPlantDataSubset %>% 
  select(reserve, genus, species, sublabel)

combinedSpeciesData <- bind_rows(animalSpeciesDataStandardized, plantSpeciesDataStandardized)

conservancyAnimalSpeciesDataStandardized <- conservancyAnimalData %>% 
  select(genus, species, sublabel = sublabel1)
conservancyPlantSpeciesDataStandardized <- conservancyPlantData %>% 
  select(genus, species, sublabel)

conservancyCombinedSpeciesData <- bind_rows(conservancyAnimalSpeciesDataStandardized, 
                                            conservancyPlantSpeciesDataStandardized)

# Calculate matching species count
matchingSpeciesCount <- matchingSpecies %>% 
  group_by(reserve) %>% 
  filter(!is.na(reserve)) %>% 
  summarize(species_in_reserve_also_in_conservancy = n()) 

totalSpeciesCount <- combinedSpeciesData %>% 
  group_by(reserve) %>% 
  filter(!is.na(reserve)) %>% 
  summarize(total_species_in_reserve = n())

total_species_in_conservancy <- nrow(conservancyCombinedSpeciesData)

# Create tables comparing proportion of plants in conservancy also in reserve and vice versa 

speciesComparisonTable <- left_join(matchingSpeciesCount, totalSpeciesCount, 
                                   by = "reserve") %>% 
  mutate(proportion_species_in_reserve_also_in_conservancy = 
           species_in_reserve_also_in_conservancy / total_species_in_reserve) %>% 
  mutate(percent_species_in_reserve_also_in_conservancy = 
           paste0(format(100 * proportion_species_in_reserve_also_in_conservancy, 
         digits = 2), "%")) %>% 
  mutate(proportion_species_in_conservancy_also_in_reserve = 
           species_in_reserve_also_in_conservancy / total_species_in_conservancy) %>% 
  mutate(percent_species_in_conservancy_also_in_reserve = 
           paste0(format(100 * proportion_species_in_conservancy_also_in_reserve, 
         digits = 2), "%")) %>% 
  arrange(desc(proportion_species_in_reserve_also_in_conservancy))

speciesComparisonTableConservancyEmphasis <- speciesComparisonTable %>% 
  arrange(desc(proportion_species_in_conservancy_also_in_reserve))

# Visualize results
speciesComparisonTableViz <- kable(speciesComparisonTable, 
                                  format = "html", align = "lcccc", 
                                  col.names = gsub("_", " ", capitalize(colnames(speciesComparisonTable)))) %>% 
  kable_styling

speciesComparisonTableConservancyEmphasisViz <- 
  kable(speciesComparisonTableConservancyEmphasis, 
        format = "html", align = "lcccc", 
        col.names = gsub("_", " ", capitalize(colnames(speciesComparisonTableConservancyEmphasis)))) %>% 
  kable_styling

speciesComparisonTableViz
speciesComparisonTableConservancyEmphasisViz

```


## Species Uniqueness Count

```{r Conservancy Plant Species with List of Reserves where Found}
# Find places where each matched species shows up in other reserves

matchingPlantsArranged <- matchingPlants %>% 
  arrange(genus, species, sublabel, reserve) 

matchingPlantsReserves <- matchingPlantsArranged  %>% 
  group_by(genus, species, sublabel) %>% 
  summarize(count = n()) 

# Add names of reserves each species is represented in at end:

matchingPlantsArranged$reserve_list <- ""

matchingPlantsArranged$reserve_list[1] <- paste0(matchingPlantsArranged$reserve[1])
idx = 2
idx_max = nrow(matchingPlantsArranged)

while(idx < idx_max) {
  n = 1
  while((setequal(matchingPlantsArranged[idx, 2:4], matchingPlantsArranged[(idx - 1), 2:4])) & (idx < idx_max)) {
    n = n + 1
    idx = idx + 1
  }
  matchingPlantsArranged$reserve_list[(idx - n):(idx - 1)] <- 
    paste(matchingPlantsArranged$reserve[(idx - n):(idx - 1)], collapse = ", ")
  idx = idx + 1
}

matchingPlantsArranged$reserve_list[idx_max] <- 
    paste(matchingPlantsArranged$reserve[idx_max])

# Combine the data

matchingPlantsReservesCombined <- matchingPlantsArranged %>% 
  distinct(genus, species, sublabel, reserve_list) %>% 
  right_join(matchingPlantsReserves, by = c("genus", "species", "sublabel"))

matchingPlantsReservesCombined
```

```{r Conservancy Animal Species with List of Reserves where Found}

# Find places where each matched species shows up in other reserves

matchingAnimalsArranged <- matchingAnimals %>% 
  arrange(genus, species, sublabel, reserve) 

matchingAnimalsReserves <- matchingAnimalsArranged  %>% 
  group_by(genus, species, sublabel) %>% 
  summarize(count = n()) 

# Add names of reserves each species is represented in at end:

matchingAnimalsArranged$reserve_list <- ""

matchingAnimalsArranged$reserve_list[1] <- paste0(matchingAnimalsArranged$reserve[1])
idx = 2
idx_max = nrow(matchingAnimalsArranged)

while(idx < idx_max) {
  n = 1
  while((setequal(matchingAnimalsArranged[idx, 2:4], matchingAnimalsArranged[(idx - 1), 2:4])) & (idx < idx_max)) {
    n = n + 1
    idx = idx + 1
  }
  matchingAnimalsArranged$reserve_list[(idx - n):(idx - 1)] <- 
    paste(matchingAnimalsArranged$reserve[(idx - n):(idx - 1)], collapse = ", ")
  idx = idx + 1
}

matchingAnimalsArranged$reserve_list[idx_max] <- 
    paste(matchingAnimalsArranged$reserve[idx_max])

# Combine the data

matchingAnimalsReservesCombined <- matchingAnimalsArranged %>% 
  distinct(genus, species, sublabel, reserve_list) %>% 
  right_join(matchingAnimalsReserves, by = c("genus", "species", "sublabel")) %>% 
  filter(!is.na(species))

matchingAnimalsReservesCombined
```

```{r Conservancy Species with List of Reserves where Found}

# Find places where each matched species shows up in other reserves

matchingSpeciesCountByReserve <- bind_rows("animal" = matchingAnimalsReservesCombined, 
                                           "plant" = matchingPlantsReservesCombined,
                                           .id = "kingdom")

uniquePlants <- conservancyPlantData %>% 
  anti_join(ucnrsPlantDataSubset, by = c("genus", "species", "sublabel")) %>% 
  select(genus, species, sublabel) %>% 
  mutate(count = 0)

uniqueAnimals <- conservancyAnimalData %>% 
  anti_join(ucnrsAnimalDataSubset, by = c("genus", "species", "sublabel1")) %>% 
  select(genus, species, sublabel = sublabel1) %>% 
  mutate(count = 0)

uniqueSpecies <- bind_rows("animal" = uniqueAnimals, "plant" = uniquePlants, .id = "kingdom") 

matchingSpeciesWithUnique <- bind_rows(matchingSpeciesCountByReserve, uniqueSpecies) %>% 
  filter(!is.na(species))

matchingSpeciesWithUnique

#Compute Number and Ratio of Rare and Unique Species

totalSpecies <- nrow(matchingSpeciesWithUnique)
totalAnimalSpecies <- nrow(matchingAnimalsReservesCombined)
totalPlantSpecies <- nrow(matchingPlantsReservesCombined)


rareOrUniqueSpecies <- matchingSpeciesWithUnique %>% filter(count < 4)

totalRareOrUniqueSpecies <- nrow(rareOrUniqueSpecies)
totalUniqueSpecies <- nrow(uniqueSpecies)

ratioRareOrUniqueSpecies <- totalRareOrUniqueSpecies / totalSpecies
ratioUniqueSpecies <- totalUniqueSpecies / totalSpecies

# Make a table for presentation

rareOrUniqueComparisonTable <- tibble("variable" = c("Unique Species (in no other reserve)", 
                                                     "Rare or Unique Species (in < 4 reserves)", 
                                                     "Total Species in Conservancy"), 
                                      "number" = c(totalUniqueSpecies, 
                                                   totalRareOrUniqueSpecies, 
                                                   totalSpecies), 
                                      "ratio" = c(ratioUniqueSpecies,
                                                  ratioRareOrUniqueSpecies,
                                                  1))

speciesComparisonTableViz <- kable(rareOrUniqueComparisonTable, 
                                  format = "html", align = "lcc", 
                                  col.names = capitalize(colnames(rareOrUniqueComparisonTable))) %>% 
  kable_styling

speciesComparisonTableViz

```

```{r Conservancy Species with List of Reserves where Found, disaggregated by rarity}

# Calculate Chart of Threshold for Species

speciesBelowReserveThreshold <- matchingSpeciesWithUnique %>% 
  group_by(count) %>% 
  rename(number_of_reserves_x = count) %>% 
  summarize(number_of_species_found_in_x_reserves = n()) %>% 
  mutate(number_of_species_found_in_x_or_fewer_reserves = 
           cumsum(number_of_species_found_in_x_reserves)) %>% 
  mutate(ratio_of_species_found_in_x_or_fewer_reserves = 
           number_of_species_found_in_x_or_fewer_reserves / 
           totalSpecies) %>%
  mutate(percent_of_species_found_in_x_or_fewer_reserves = 
           paste0(format(100 * ratio_of_species_found_in_x_or_fewer_reserves, 
         digits = 3), "%"))
  
speciesBelowReserveThreshold
  

# Calculate Chart of Threshold for Animals

animalsBelowReserveThreshold <- matchingSpeciesWithUnique %>% 
  group_by(count, kingdom) %>% 
  summarize(number_of_species_found_in_x_reserves = n()) %>% 
  filter(kingdom == "animal") %>% 
  select(number_of_reserves_x = count, 
         number_of_species_found_in_x_reserves) %>% 
  ungroup() %>% 
  mutate(number_of_species_found_in_x_or_fewer_reserves = 
           cumsum(number_of_species_found_in_x_reserves)) %>% 
  mutate(ratio_of_species_found_in_x_or_fewer_reserves = 
           number_of_species_found_in_x_or_fewer_reserves / 
           totalSpecies) %>%
  mutate(percent_of_species_found_in_x_or_fewer_reserves = 
           paste0(format(100 * ratio_of_species_found_in_x_or_fewer_reserves, 
         digits = 3), "%"))

animalsBelowReserveThreshold


# Calculate Chart of Threshold for Plants

plantsBelowReserveThreshold <- matchingSpeciesWithUnique %>% 
  group_by(count, kingdom) %>% 
  summarize(number_of_species_found_in_x_reserves = n()) %>% 
  filter(kingdom == "plant") %>% 
  select(number_of_reserves_x = count, 
         number_of_species_found_in_x_reserves) %>% 
  ungroup() %>% 
  mutate(number_of_species_found_in_x_or_fewer_reserves = 
           cumsum(number_of_species_found_in_x_reserves)) %>% 
  mutate(ratio_of_species_found_in_x_or_fewer_reserves = 
           number_of_species_found_in_x_or_fewer_reserves / 
           totalSpecies) %>%
  mutate(percent_of_species_found_in_x_or_fewer_reserves = 
           paste0(format(100 * ratio_of_species_found_in_x_or_fewer_reserves, 
         digits = 3), "%"))

plantsBelowReserveThreshold

# Bind tables, combining by level



# Make a table for presentation

speciesComparisonTableViz <- kable(rareOrUniqueComparisonTable, 
                                  format = "html", align = "lcc", 
                                  col.names = capitalize(colnames(rareOrUniqueComparisonTable))) %>% 
  kable_styling

speciesComparisonTableViz

```

## Summary Statistics

```{r Plots of Conservancies with Closest Matches}

speciesComparisonTable %>% 
  filter(match_ratio > 0.25) %>% 
  ggplot(aes(x = reorder(reserve, match_ratio), y = match_ratio)) + 
  geom_bar(stat = "identity") +
  coord_flip()

```



